--1. CREATE A TABLE WITH IDENTITY COLUMN

CREATE TABLE DeeperLifeDCMembers1(ID TINYINT IDENTITY(1,1) PRIMARY KEY NOT NULL, FirstName VARCHAR(20), LatestAttendance Datetime NOT NULL DEFAULT GETDATE());

--POPULATE 5 ROWS
INSERT INTO DeeperLifeDCMembers1 VALUES('Michael', DEFAULT);
INSERT INTO DeeperLifeDCMembers1 VALUES('Charles', DEFAULT);
INSERT INTO DeeperLifeDCMembers1 VALUES('Christopher', DEFAULT);
INSERT INTO DeeperLifeDCMembers1 VALUES('Christian', DEFAULT);
INSERT INTO DeeperLifeDCMembers1 VALUES('Nkechi', DEFAULT);

--CREATE AN EXACT COPY OF AN EXISTING TABLE 
SELECT * INTO DeeperLifeDCMembers_STAGING FROM DeeperLifeDCMembers1;

--INSERT A NEW ROW IN THE NEW TABLE
INSERT INTO DeeperLifeDCMembers_STAGING(FirstName, LatestAttendance)
VALUES('BARY', GETDATE());

--MERGE THE TWO TABLES
MERGE DeeperLifeDCMembers1 TARGET
USING DeeperLifeDCMembers_STAGING SOURCE
ON (TARGET.ID = SOURCE.ID)
WHEN MATCHED AND TARGET.FirstName <> SOURCE.FirstName
THEN UPDATE SET TARGET.FirstName = SOURCE.FirstName
WHEN NOT MATCHED BY TARGET
THEN INSERT (FirstName, LatestAttendance) VALUES('BARY', GETDATE())
WHEN NOT MATCHED BY SOURCE
THEN DELETE;

UPDATE DeeperLifeDCMembers1 SET FirstName = 'NONYE'
WHERE ID = 5;
UPDATE DeeperLifeDCMembers1 SET FirstName = 'JOSEPH'
WHERE ID = 6;

--CREATE YOUR MERGED STATED AS A STORED PROCEDURE
CREATE PROCEDURE StoredInfo AS
MERGE DeeperLifeDCMembers1 TARGET
USING DeeperLifeDCMembers_STAGING SOURCE
ON (TARGET.ID = SOURCE.ID)
WHEN MATCHED AND TARGET.FirstName <> SOURCE.FirstName
THEN UPDATE SET TARGET.FirstName = SOURCE.FirstName
WHEN NOT MATCHED BY TARGET
THEN INSERT (FirstName, LatestAttendance) VALUES('BARY', GETDATE())
WHEN NOT MATCHED BY SOURCE
THEN DELETE;

DELETE FROM DeeperLifeDCMembers1;

EXECUTE StoredInfo;

SELECT * FROM DeeperLifeDCMembers_STAGING;
SELECT * FROM DeeperLifeDCMembers1;